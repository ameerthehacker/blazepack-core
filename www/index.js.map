{"version":3,"sources":["../constants.js","../../package.json","index.js"],"names":["WS_EVENTS","PATCH","INIT","ERROR","UNHANDLED_SANDPACK_ERROR","module","exports","compile","window","getSandboxTemplate","getTemplate","getTemplateDefinition","info","message","console","log","name","ws","WebSocket","location","host","sandboxFiles","manager","onopen","getFilename","filePath","fileParts","split","filename","length","getHTMLParts","html","includes","bodyMatcher","headMatcher","headMatch","match","bodyMatch","head","body","getSandboxTemplateName","packageJSON","JSON","parse","code","sandboxTemplate","onmessage","evt","data","type","sandboxTemplateDefinition","htmlEntryFile","getHTMLEntries","htmlContent","document","innerHTML","modules","codesandbox","externalResources","template","isInitializationCompile","event","fileContent","path","reload","updatedFiles","e","send","stringify","title"],"mappings":"ACAAK,ADAA,IAAML,ECAA,CAACM,MDAQ,CCAf,EDAkB,CCAD;AACf,ADAAL,EAAAA,KAAK,EAAE,CCAC,MDDQ,KCAD;AAEf,ADAAC,EAAAA,IAAI,EAAE,KCAK,CDFK,OCAD;AAGf,ADAAC,EAAAA,KAAK,EAAE,OAHS,CCGD,+CAHA;AAIf,ADAAC,EAAAA,QCAQ,gBDAgB,EAAE,ECJX;AAKf,ADLgB,CAAlB,QCKS;AACL,ADCJC,MAAM,CAACC,OAAP,GCDiB,ADCA;ACFR,ADEUN,AEPnB,EFOmBA,CCPF,QDOW,EAATA;ACCjB,ADDe,CAAjB,YCCa;AACT,ACRJ,oBDQoB,2DADP;AAET,kBAAc,qDAFL;AAGT,kBAAc;AAHL,GARI;AAaf,gBAAc;AACZ,YAAQ,KADI;AAEZ,WAAO;AAFK,GAbC;AAiBf,ACdF,IAAMO,OAAO,GDcC,ACdEC,CDeZ,KCfkB,CAACD,ODcT,ACdd,EDgBI,KAFU,EAGV,QAHU,EAIV,YAJU,CAjBG;AAuBf,ACnBF,IAAME,QDmBM,UCnBY,EDJP,CCIUD,MAAM,CAACE,WAAlC;ADoBE,ACnBF,IAAMC,SDmBO,KAxBI,OCKU,GAAGH,MAAM,CAACG,qBAArC;ADoBE,UAAQ;AACN,ACpBJ,IAAMC,IAAI,GDoBC,ACpBE,SAAPA,IAAO,CAACC,OAAD;ADmBH,ACnBG,GDNI,MCMSC,OAAO,CAACC,GAAR,WAAeC,aAAf,eAAwBH,OAAxB,EAAb;ADsBX,ACtBW,CAAb,aDsBc,oDA5BG;AA6Bf,qBAAmB;AACjB,ACvBJ,IAAMI,EAAE,GAAG,IAAIC,SDuBO,ACvBX,gBAAsBV,MAAM,CAACW,QAAP,CAAgBC,IAAtC,EAAX;ADsBqB,ACrBrB,GDRiB,CCQbC,YAAJ;ADwBE,ACvBF,IAAIC,OAAJ,ODuBkB;AACd,aAAS,QADK;AAEd,ACvBJL,EAAE,CAACM,MAAH,GAAY,IDuBI,QAFE;AAGd,ACxBQ,SAAMX,IAAI,CAAC,ODwBF,ICxBC,CAAV,GDqBM;AAId,ACzBQ,CAAZ,kBDyBmB,QAJD;AAKd,yBAAqB,QALP;AAMd,ACzBJ,SAASY,WAAT,CDyBqB,ACzBAC,QDmBH,ACnBlB,EAA+B;AD0B3B,ACzBF,MAAMC,SAAS,GAAGD,IDyBE,ICzBM,CAACE,GDkBX,EClBE,CAAe,GAAf,CAAlB;AD0BE,ACzBF,MAAMC,QAAQ,EDyBA,CCzBGF,ODiBD,ECjBU,CAACA,SAAS,CAACG,MAAV,GAAmB,CAApB,CAA1B;AD0BE,ACxBF,SAAOD,GDwBG,KCxBV,GDegB;AAUd,ACxBH,UDwBS;AAVQ;AAhCD,ACoBV,CDpBP,QCoBgBE,YAAT,CAAsBC,IAAtB,EAA4B;AACjC,MAAIA,IAAI,CAACC,QAAL,CAAc,QAAd,CAAJ,EAA6B;AAC3B,QAAMC,WAAW,GAAG,4BAApB;AACA,QAAMC,WAAW,GAAG,0BAApB;AAEA,QAAMC,SAAS,GAAGJ,IAAI,CAACK,KAAL,CAAWF,WAAX,CAAlB;AACA,QAAMG,SAAS,GAAGN,IAAI,CAACK,KAAL,CAAWH,WAAX,CAAlB;AACA,QAAMK,IAAI,GAAGH,SAAS,IAAIA,SAAS,CAAC,CAAD,CAAtB,GAA4BA,SAAS,CAAC,CAAD,CAArC,GAA2C,EAAxD;AACA,QAAMI,IAAI,GAAGF,SAAS,IAAIA,SAAS,CAAC,CAAD,CAAtB,GAA4BA,SAAS,CAAC,CAAD,CAArC,GAA2CN,IAAxD;AAEA,WAAO;AAAEQ,MAAAA,IAAI,EAAJA,IAAF;AAAQD,MAAAA,IAAI,EAAJA;AAAR,KAAP;AACD;;AAED,SAAO;AAAEA,IAAAA,IAAI,EAAE,EAAR;AAAYC,IAAAA,IAAI,EAAER;AAAlB,GAAP;AACD;;AAED,SAASS,sBAAT,CAAgCnB,YAAhC,EAA8C;AAC5C,MAAMoB,WAAW,GAAGC,IAAI,CAACC,KAAL,CAAWtB,YAAY,CAAC,eAAD,CAAZ,CAA8BuB,IAAzC,CAApB;AACA,MAAMC,eAAe,GAAGpC,kBAAkB,CAACgC,WAAD,EAAcpB,YAAd,CAA1C;AAEA,SAAOwB,eAAP;AACD;;AAED5B,EAAE,CAAC6B,SAAH,GAAe,UAACC,GAAD,EAAS;AAAA,oBACCL,IAAI,CAACC,KAAL,CAAWI,GAAG,CAACC,IAAf,CADD;AAAA,MACdC,IADc,eACdA,IADc;AAAA,MACRD,IADQ,eACRA,IADQ;;AAGtB,MAAI;AACF,YAAQC,IAAR;AACE,WAAKjD,qBAAUE,IAAf;AAAqB;AACnBmB,UAAAA,YAAY,GAAG2B,IAAf;AACA,cAAMH,eAAe,GAAGL,sBAAsB,CAACnB,YAAD,CAA9C;AACA,cAAM6B,yBAAyB,GAAGvC,qBAAqB,CAACkC,eAAD,CAAvD;AACA,cAAMM,aAAa,GAAGD,yBAAyB,CAACE,cAA1B,GAA2C,CAA3C,CAAtB;;AAEA,cAAID,aAAJ,EAAmB;AACjB,gBAAME,WAAW,GAAGhC,YAAY,CAAC8B,aAAD,CAAZ,CAA4BP,IAAhD;;AADiB,gCAEAd,YAAY,CAACuB,WAAD,CAFZ;AAAA,gBAETf,IAFS,iBAETA,IAFS;;AAIjBgB,YAAAA,QAAQ,CAAChB,IAAT,CAAciB,SAAd,GAA0BjB,IAA1B;AACD;;AAED/B,UAAAA,OAAO,CAAC;AACNiD,YAAAA,OAAO,EAAEnC,YADH;AAENoC,YAAAA,WAAW,EAAE,IAFP;AAGNC,YAAAA,iBAAiB,EAAE,EAHb;AAINC,YAAAA,QAAQ,EAAEnB,sBAAsB,CAACnB,YAAD,CAJ1B;AAKNuC,YAAAA,uBAAuB,EAAE;AALnB,WAAD,CAAP;AAQA;AACD;;AACD,WAAK5D,qBAAUC,KAAf;AAAsB;AAAA,cACZ4D,KADY,GACiBb,IADjB,CACZa,KADY;AAAA,cACLC,WADK,GACiBd,IADjB,CACLc,WADK;AAAA,cACQC,IADR,GACiBf,IADjB,CACQe,IADR;AAEpB,cAAMnC,QAAQ,GAAGJ,WAAW,CAACuC,IAAD,CAA5B,CAFoB,CAIpB;;AACA,cAAInC,QAAQ,KAAK,cAAjB,EAAiC;AAC/BpB,YAAAA,MAAM,CAACW,QAAP,CAAgB6C,MAAhB;AACD,WAPmB,CASpB;;;AACA,cAAIH,KAAK,KAAK,KAAV,IAAmBA,KAAK,KAAK,QAAjC,EAA2C;AACzCrD,YAAAA,MAAM,CAACW,QAAP,CAAgB6C,MAAhB;AACD;;AAED,cAAMC,YAAY,mCAAQ5C,YAAR,2BAAuB0C,IAAvB,EAA8B;AAAEnB,YAAAA,IAAI,EAAEkB,WAAR;AAAqBC,YAAAA,IAAI,EAAJA;AAArB,WAA9B,EAAlB;;AAEAxD,UAAAA,OAAO,CAAC;AACNiD,YAAAA,OAAO,EAAES,YADH;AAENR,YAAAA,WAAW,EAAE,IAFP;AAGNC,YAAAA,iBAAiB,EAAE,EAHb;AAINC,YAAAA,QAAQ,EAAEnB,sBAAsB,CAACyB,YAAD;AAJ1B,WAAD,CAAP;AAOA;AACD;AAhDH;AAkDD,GAnDD,CAmDE,OAAMC,CAAN,EAAS;AACRjD,IAAAA,EAAE,CAACkD,IAAH,CACEzB,IAAI,CAAC0B,SAAL,CAAe;AACbnB,MAAAA,IAAI,EAAEjD,qBAAUI,wBADH;AAEb4C,MAAAA,IAAI,EAAE;AACJqB,QAAAA,KAAK,EAAE,iDADH;AAEJxD,QAAAA,OAAO,EAAEqD,CAAC,CAACrD;AAFP;AAFO,KAAf,CADF;AASF;AACF,CAjED","file":"index.js","sourceRoot":"..","sourcesContent":["const WS_EVENTS = {\n  PATCH: 'PATCH',\n  INIT: 'INIT',\n  ERROR: 'ERROR',\n  UNHANDLED_SANDPACK_ERROR: 'UNHANDLED_SANDPACK_ERROR'\n}\n\nmodule.exports = { WS_EVENTS };\n","module.exports = {\n  \"name\": \"blazepack\",\n  \"version\": \"0.0.16\",\n  \"description\": \"Blazing fast dev server powered by smooshpack\",\n  \"main\": \"./bin/blazepack.js\",\n  \"bin\": {\n    \"blazepack\": \"./bin/blazepack.js\"\n  },\n  \"scripts\": {\n    \"build-client\": \"parcel build src/client/index.js --out-dir src/client/www\",\n    \"dev-client\": \"parcel src/client/index.js --out-dir src/client/www\",\n    \"prepublish\": \"npm run build-client\"\n  },\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"git+https://github.com/ameerthehacker/blazepack.git\"\n  },\n  \"keywords\": [\n    \"codesandbox\",\n    \"dev\",\n    \"server\",\n    \"smooshpack\"\n  ],\n  \"author\": \"Ameer Jhan\",\n  \"license\": \"GPL\",\n  \"bugs\": {\n    \"url\": \"https://github.com/ameerthehacker/blazepack/issues\"\n  },\n  \"homepage\": \"https://github.com/ameerthehacker/blazepack#readme\",\n  \"devDependencies\": {\n    \"parcel-bundler\": \"^1.12.4\"\n  },\n  \"dependencies\": {\n    \"chalk\": \"^4.1.0\",\n    \"chokidar\": \"^3.5.1\",\n    \"detect-indent\": \"^6.0.0\",\n    \"extract-zip\": \"^2.0.1\",\n    \"find-package-json\": \"^1.2.0\",\n    \"get-all-files\": \"^3.0.0\",\n    \"latest-version\": \"^5.1.0\",\n    \"minimist\": \"^1.2.5\",\n    \"open\": \"^7.4.1\",\n    \"ws\": \"^7.4.3\"\n  }\n}\n;","import { WS_EVENTS } from '../constants';\nimport { name } from '../../package.json';\n\nconst compile = window.compile;\nconst getSandboxTemplate = window.getTemplate;\nconst getTemplateDefinition = window.getTemplateDefinition;\nconst info = (message) => console.log(`${name}: ${message}`)\nconst ws = new WebSocket(`ws://${window.location.host}`);\nlet sandboxFiles;\nlet manager;\n\nws.onopen = () => info('connected');\n\nfunction getFilename(filePath) {\n  const fileParts = filePath.split('/');\n  const filename = fileParts[fileParts.length - 1];\n\n  return filename;\n}\n\nexport function getHTMLParts(html) {\n  if (html.includes('<body>')) {\n    const bodyMatcher = /<body.*>([\\s\\S]*)<\\/body>/m;\n    const headMatcher = /<head>([\\s\\S]*)<\\/head>/m;\n\n    const headMatch = html.match(headMatcher);\n    const bodyMatch = html.match(bodyMatcher);\n    const head = headMatch && headMatch[1] ? headMatch[1] : '';\n    const body = bodyMatch && bodyMatch[1] ? bodyMatch[1] : html;\n\n    return { body, head };\n  }\n\n  return { head: '', body: html };\n}\n\nfunction getSandboxTemplateName(sandboxFiles) {\n  const packageJSON = JSON.parse(sandboxFiles['/package.json'].code);\n  const sandboxTemplate = getSandboxTemplate(packageJSON, sandboxFiles);\n\n  return sandboxTemplate;\n}\n\nws.onmessage = (evt) => {\n  const { type, data } = JSON.parse(evt.data);\n  \n  try {\n    switch (type) {\n      case WS_EVENTS.INIT: {\n        sandboxFiles = data;\n        const sandboxTemplate = getSandboxTemplateName(sandboxFiles);\n        const sandboxTemplateDefinition = getTemplateDefinition(sandboxTemplate);\n        const htmlEntryFile = sandboxTemplateDefinition.getHTMLEntries()[0];\n\n        if (htmlEntryFile) {\n          const htmlContent = sandboxFiles[htmlEntryFile].code;\n          const { head } = getHTMLParts(htmlContent);\n\n          document.head.innerHTML = head;\n        }\n\n        compile({\n          modules: sandboxFiles,\n          codesandbox: true,\n          externalResources: [],\n          template: getSandboxTemplateName(sandboxFiles),\n          isInitializationCompile: true \n        });\n\n        break;\n      }\n      case WS_EVENTS.PATCH: {\n        const { event, fileContent, path } = data;\n        const filename = getFilename(path);\n\n        // we need to reload so that sandpack can install the package\n        if (filename === \"package.json\") {\n          window.location.reload();\n        }\n\n        // do a full page reload on new file or folder creation or deletion\n        if (event === \"add\" || event === \"unlink\") {\n          window.location.reload();\n        }\n\n        const updatedFiles = { ...sandboxFiles, [path]: { code: fileContent, path } };\n\n        compile({\n          modules: updatedFiles,\n          codesandbox: true,\n          externalResources: [],\n          template: getSandboxTemplateName(updatedFiles)\n        });\n        \n        break;\n      }\n    }\n  } catch(e) {\n     ws.send(\n       JSON.stringify({\n         type: WS_EVENTS.UNHANDLED_SANDPACK_ERROR,\n         data: {\n           title: \"Unhandled Sandpack error while running the app.\",\n           message: e.message,\n         },\n       })\n     );\n  }\n}"]}